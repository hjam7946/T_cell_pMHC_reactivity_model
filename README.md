## Table of Contents

- [Section I: Introduction](#section-i-introduction)
- [Section II: Running Independent Model Simulations](#section-ii-running-independent-model-simulations)
- [Section III: Genetic Algorithm Fitting](#section-iii-genetic-algorithm-fitting)
- [Section IV: Figure 1](#section-iv-figure-1)
- [Section V: Figure 2](#section-v-figure-2)
- [Section VI: Figure 3](#section-vi-figure-3)
- [Section VII: Figure 4](#section-vii-figure-4)
- [Section VIII: Figure 5](#section-viii-figure-5)
- [Section IX: Figure S1](#section-ix-figure-s1)
- [Section X: Figure S2](#section-x-figure-s2)
- [Section XI: Figure S3](#section-xi-figure-s3)
- [Section XII: Figure S5](#section-xii-figure-s5)
- [Section XIII: Figure S6](#section-xiii-figure-s6)
- [Section XIV: Movie S1](#section-xiv-movie-s1)
- [Section XV: Movie S2](#section-xv-movie-s2)
- [Section XVI: Auxiliary Codes](#section-xvi-auxiliary-codes)

---

## Section I: Introduction

This file describes how to use the MATLAB codes provided with the manuscript entitled "Chronic pathogen control relies on T cells with lower foreign antigen binding strength generated by N-nucleotide diversity" by H. Jamaleddine, D. Rogers, G. Perreault, J. Postat, D. Patel, J.N. Mandl, and A. Khadra. All code was written by H. Jamaleddine, please direct any technical questions about the code to hassan (dot) jamaleddine (at) mail (dot) mcgill (dot) ca.

The MATLAB codes that generate the plots of the modeling results included in the figures in the main/supplemental text are, respectively:
- AvC_figs_main.m (for Figures 1B-C, 2A-F, 3, 4A-E, and 5A-C in the main text)
- AvC_figs_supp.m (for Figures S1A-C, S2, S3, S5, S6 and Movies S1, S2 in SI)

These scripts should plot the modeling results. To select which figure to plot, modify the `fig_num` specification at the top of each script as indicated. Ensure all complimentary code present in the repository is included in the MATLAB path.

All figures are generated by loading the results from the genetic algorithm (see Section III), saved in the folder: `/AvC - Fits/ga-2022-10-24-at-05-13-49/`. Specific modifications to parameters used to generate the simulations are outlined in the main and supplemental text.

---

## Section II: Running Independent Model Simulations

The model can be simulated using the function `AvC_2_3.m` - to simulate T cell response to acute or chronic infection, respectively, run:
```matlab
[t_a, sol_a] = AvC_2_3('acute',WT)
[t_c, sol_c] = AvC_2_3('chronic',WT)
```
where `t_a/t_c` are the time vectors and `sol_a/sol_c` are the MATLAB structs containing the solutions over time.

This uses default parameter values generated by the genetic algorithm fit (see Section III), except for the initial pathogen loads which are set to 100 PFU/mL unless otherwise specified. `AvC_2_3` can take in other input arguments too, including (but not limited to) name/value pairs for each of the parameters of the model. For more information on how to use this, enter the following at the MATLAB command window: `help AvC_2_3`

---

## Section III: Genetic Algorithm Fitting

The model parameters were determined using a genetic algorithm (see SI Text). The codes used to generate these model fits are:
- AvC_2_3_fitting.m (script to run)
- AvC_2_3_getModelPrediction.m (function called by the above script)

`AvC_2_3_fitting.m` is the script that can be run to refit the model with the genetic algorithm. It calls the function `AvC_2_3_getModelPrediction.m` to generate the model time series for a specific set of parameters being tested by the algorithm, which in turn calls `AvC_2_3.m` (see Section II).

The digitized data (Wherry et al., J Virol 2003) used by the algorithm to fit the model is saved in:
- LCMVserumWherry.mat

The function loads this data into the MATLAB workspace to then fit the model to.

Note that this code can take hours to run; it is set to run for a maximum time of 9 hours (but this can be altered on line 65 by changing maxTime). It uses parallel computing.

The code used to fit the exponential growth rates and initial pathogen loads during early infection (see SI Text) is provided in:
- AvC_2_3_estimateExpPars.m (script)

---

## Section IV: Figure 1

This figure pertains to the model design and its parameters. To plot panels B-C, run `AvC_figs_main.m` with `fig_num = 1` on line 12. For efficiency, instead of rerunning multiple model simulations to generate the 'Individual' and 'Average' traces for kappa_E as a function of pMHC reactivity, these data were saved in:
- AvC_2_3_kappas.mat
To rerun them, uncomment lines 80-95 (and comment line 96).

The model scheme in Panel A was added to the Figure in post-processing.

---

## Section V: Figure 2

This figure pertains to the model time series of acute and chronic pathogen loads and the evolution of pMHC reactivity in response to acute and chronic infection. To plot, run `AvC_figs_main.m` with `fig_num = 2` on line 12. Only the modeling results (Figures 2A-F) are plotted. Experimental results were added to the Figure in post-processing.

---

## Section VI: Figure 3

This figure pertains to the effect of modifying the mode or span of the pMHC-reactivity distribution profile. To plot, run `AvC_figs_main.m` with `fig_num = 3` on line 12. This section of the code uses data that was generated by running:
- AvC_2_3_varyingDists.m
with 'repRateValue' on line 20 set to 'default' and 'kappaStyle' on line 21 set to 'exponential'. This can take some time to run and uses parallel computing to speed it up. To disable parallel computing, change 'parfor' to 'for' on line 129.

The data obtained from running `AvC_2_3_varyingDists.m

` with these specifications was saved into:
- AvC_2_3_effectOfDists.mat
`AvC_figs_main.m` loads this data into the MATLAB workspace to plot the effect of varying the distribution mode and span.

---

## Section VII: Figure 4

This figure pertains to the in silico removal of low-affinity T cells and its effect on pathogen clearance. To plot, run `AvC_figs_main.m` with `fig_num = 4` on line 12. Only the modeling results (Figure 4A-E) are plotted. Experimental results were added to the Figure in post-processing. To generate the data plotted in Figure 4A-B, run:
- AvC_2_3_numericalKO.m
with 'keepTotConstant' on line 32 set to true, 'repRateValue' on line 33 set to 'default', and 'kappaStyle' on line 34 set to 'exponential'. This can take some time to run and uses parallel computing to speed it up. To disable parallel computing, change 'parfor' to 'for' on line 150.

The data obtained from running `AvC_2_3_numericalKO.m` with these specifications were saved into:
- AvC_2_3_numericalKO.mat

The clearance time data shown in the violin plots of Figure 4E, for efficiency, were saved into:
- AvC_2_3_WTvsdTCR_ttc.mat
To regenerate, set `computettcs` on line 422 to true.

---

## Section VIII: Figure 5

This figure pertains to the in silico removal of low-affinity T cells and its effect on Crypto pathogen loads. To plot, run `AvC_figs_main.m` with `fig_num = 5` on line 12. Only the modeling results are plotted. Experimental results were added to the Figure in post-processing. The CFU data shown in the violin plots of Figure 5C, for efficiency, were saved into:
- AvC_2_3_WTvsdTCR_crypto.mat
To regenerate, set `computeCFUs` on line 741 to true.

The digitized crypto pathogen load data was obtained from Sionov et al., 2015 (lung, untreated cohort).

---

## Section IX: Figure S1

This figure is complementary to the results of Figure 2, showing the viral load data with model simulations overlayed. To plot, run `AvC_figs_supp.m` with `fig_num = 'S1'` on line 13. The 100 times to pathogen clearance plotted in Figure S1C, for efficiency, were saved into:
- AvC_2_3_defaultTTCs.mat
To regenerate the 100 pathogen clearance times during acute and chronic infection, set `computettcs` on line 48 to true.

The digitized data obtained from Wherry et al., J Virol 2003 was loaded from:
- LCMVserumWherry.mat

---

## Section X: Figure S2

This figure pertains to the bifurcation analysis of the 1-clone, 2D model. To plot, run `AvC_figs_supp.m` with `fig_num = 'S2'` on line 13. The bifurcation data were obtained by loading the following .ODE file into XPP/AUTO (freeware available at [XPP/AUTO](http://sites.pitt.edu/~phase/bard/bardware/xpp/xpp.html)):
- AvC_2_3_log.ode
Note that this is the 2D, one-clone system of log-scaled parameters log10(V+1) and log10(E+1), where V is the pathogen load (P in paper) and E represents effector T cells.

The bifurcation data in panels A, B, and C generated by XPP/AUTO with the above ODE file were saved, respectively, as:
- AvC_2_3_logVvsKexp_revised.dat
- AvC_2_3_logVvsKappaE_revised.dat
- AvC_2_3_KexpVsKappaE_revised.dat
They can be found in the folder: `/AvC - Bifurcation Data/`

---

## Section XI: Figure S3

This figure, complementary to Figure 4, pertains to the in silico removal of low-affinity T cells when chronic pathogen replication rate is reduced. To plot, run `AvC_figs_supp.m` with `fig_num = 'S3'` on line 13. To generate the data plotted in this figure, run:
- AvC_2_3_numericalKO.m
with 'keepTotConstant' on line 32 set to true (panels A-B) or false (panels C-D), 'repRateValue' on line 33 set to 'reduced' and 'kappaStyle' on line 34 set to 'exponential'.

The data generated from the above function for panels A-B and C-D were saved, respectively, into:
- AvC_2_3_numericalKO_reducedRep.mat
- AvC_2_3_numericalKO_reducedRep_notConserved.mat
and loaded by the script to plot.

---

## Section XII: Figure S5

This figure pertains to the alternative dTCR repertoire models. To plot, run `AvC_figs_supp.m` with `fig_num = 'S5'` on line 13. The clearance time data shown in the violin plots of Figure S5C and F, for efficiency, were saved into:
- AvC_2_3_WTvsdTCR_lcmv_alternative.mat
To regenerate, set `computettcs` on line 400 to true.

---

## Section XIII: Figure S6

This figure shows the model results are unaffected when drawing exhaustion rates kappa_E from a uniform distribution as opposed to an exponential distribution (the latter being the default used throughout the text). To plot, run `AvC_figs_supp.m` with `fig_num = 'S6'` on line 13.

For efficiency, instead of rerunning multiple model simulations to generate the 'Individual' and 'Average' traces for kappa_E as a function of pMHC reactivity (panel A), these data were saved in:
- AvC_2_3_kappas_uniform.mat
To rerun them, uncomment lines 826-842 (and comment line 843).

The clearance data in panel D was generated by running:
- AvC_2_3_varyingDists.m
with 'repRateValue' on line 20 set to 'default' and 'kappaStyle' on line 21 set to 'uniform'. The data obtained from running `AvC_2_3_varyingDists.m` with these specifications was saved into:
- AvC_2_3_effectOfMode_uniform.mat
`AvC_figs_supp.m` loads this data into the MATLAB workspace to plot the effect of varying the distribution mode.

The clearance data in panel E was generated by running:
- AvC_2_3_numericalKO.m
with 'keepTotConstant' on line 32 set to true, 'repRateValue' on line 33 set to

 'default' and 'kappaStyle' on line 34 set to 'uniform'. The data obtained from running `AvC_2_3_numericalKO.m` with these specifications was saved into:
- AvC_2_3_numericalKO_uniform.mat
`AvC_figs_supp.m` loads this data into the MATLAB workspace to plot the effect of removing low-affinity T cells.

---

## Section XIV: Movie S1

This movie shows the evolution of the pMHC-reactivity distribution more clearly in time. To regenerate, run `AvC_figs_supp.m` with `fig_num = 'M1'` on line 13. This will write a .GIF file with the name 'timeSeries.gif' that will be saved to the current path. Note: newer versions of MATLAB will be necessary.

---

## Section XV: Movie S2

This movie shows the evolution of the nullclines of the 2D system in time, with the trajectory of the full system overlayed. To regenerate, run `AvC_figs_supp.m` with `fig_num = 'M2'` on line 13. This will write a .GIF file with the name 'nullclines.gif' that will be saved to the current path. Note: newer versions of MATLAB will be necessary.

---

## Section XVI: Auxiliary Codes

This section briefly describes the other MATLAB functions/scripts/files included in the repository. All of these need to be in the MATLAB path in order for the above scripts to properly function. These are:
- `plotter.m`: custom function to call MATLAB's built-in plot.m
- `subplotter.m`: custom function to call MATLAB's built-in subplot.m
- `figurer.m`: custom function to call MATLAB's built-in figure.m
- `xpp_plot.m`: function to plot bifurcation diagrams from XPP/AUTO (Fig S2)
- `staggerscatter.m`: plot scatter plots using MATLAB's swarmchart.m
- `customcolormap.m`: define a custom colormap for surfaces (e.g., pMHC reactivity)

To see how to use any of these, use MATLAB's 'help' tool in the command window, e.g., `help plotter`.

Also ensure that the following folder is included in the MATLAB path to plot violin plots (Figs. 4E and S5C,F):
`/Violinplot-Matlab-master/`
This code was obtained from [Violinplot-Matlab](http://github.com/bastibe/Violinplot-Matlab).
```

You can copy and paste this markdown into a README.md file for your project. If you have any additional information or updates to include, feel free to edit the document accordingly.